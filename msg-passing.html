<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Message Passing in Elixir, Clojure and Go - Strange Ideas</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/msg-passing.html">

        <meta name="author" content="Steven Cook" />
        <meta name="keywords" content="Elixir,Go,Clojure" />
        <meta name="description" content="I have spent some time recently learning Elixir. I have always been interested in Erlang, but the syntax has put me off in the past. One of the examples in the book Programming Elixir involves creating 1,000,000 processes and sending and incrementing an integer through the chain. The ..." />

        <meta property="og:site_name" content="Strange Ideas" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Message Passing in Elixir, Clojure and Go"/>
        <meta property="og:url" content="/msg-passing.html"/>
        <meta property="og:description" content="I have spent some time recently learning Elixir. I have always been interested in Erlang, but the syntax has put me off in the past. One of the examples in the book Programming Elixir involves creating 1,000,000 processes and sending and incrementing an integer through the chain. The ..."/>
        <meta property="article:published_time" content="2015-08-14" />
            <meta property="article:section" content="programming" />
            <meta property="article:tag" content="Elixir" />
            <meta property="article:tag" content="Go" />
            <meta property="article:tag" content="Clojure" />
            <meta property="article:author" content="Steven Cook" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Strange Ideas            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/misc.html">Misc</a>
                        </li>
                        <li class="active">
                            <a href="/category/programming.html">Programming</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/msg-passing.html"
                       rel="bookmark"
                       title="Permalink to Message Passing in Elixir, Clojure and Go">
                        Message Passing in Elixir, Clojure and Go
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-08-14T00:00:00+10:00"> Fri 14 August 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/elixir.html">Elixir</a>
        /
	<a href="/tag/go.html">Go</a>
        /
	<a href="/tag/clojure.html">Clojure</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I have spent some time recently learning Elixir. I have always been interested in Erlang, but the syntax has put me off in the past. One of the examples in the book Programming Elixir involves creating 1,000,000 processes and sending and incrementing an integer through the chain. The Elixir code is:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1"># Excerpted from &quot;Programming Elixir&quot;,</span>
<span class="c1"># published by The Pragmatic Bookshelf.</span>
<span class="kd">defmodule</span> <span class="nc">Chain</span> <span class="k">do</span>
  <span class="kd">def</span> <span class="n">counter</span><span class="p">(</span><span class="n">next_pid</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">receive</span> <span class="k">do</span>
      <span class="n">n</span> <span class="o">-&gt;</span>
        <span class="n">send</span> <span class="n">next_pid</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kd">def</span> <span class="n">create_processes</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">last</span> <span class="o">=</span> <span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span> <span class="mi">1</span><span class="o">..</span><span class="n">n</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span>
             <span class="k">fn</span> <span class="p">(</span><span class="bp">_</span><span class="p">,</span><span class="n">send_to</span><span class="p">)</span> <span class="o">-&gt;</span>
               <span class="n">spawn</span><span class="p">(</span><span class="nc">Chain</span><span class="p">,</span> <span class="ss">:counter</span><span class="p">,</span> <span class="p">[</span><span class="n">send_to</span><span class="p">])</span>
             <span class="k">end</span>

    <span class="c1"># start the count by sending</span>
    <span class="n">send</span> <span class="n">last</span><span class="p">,</span> <span class="mi">0</span>

    <span class="c1"># and wait for the result to come back to us</span>
    <span class="k">receive</span> <span class="k">do</span>
      <span class="n">final_answer</span> <span class="ow">when</span> <span class="n">is_integer</span><span class="p">(</span><span class="n">final_answer</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="s2">&quot;Result is </span><span class="si">#{</span><span class="n">inspect</span><span class="p">(</span><span class="n">final_answer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kd">def</span> <span class="n">run</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do</span>
    <span class="nc">IO</span><span class="o">.</span><span class="n">puts</span> <span class="n">inspect</span> <span class="ss">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p">(</span><span class="nc">Chain</span><span class="p">,</span> <span class="ss">:create_processes</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>

<p>This run in about 8-9sec on my Macbook Pro for 1,000,000 processes.</p>
<p>I was interested in how this would work in Clojure using core.async. I came up with the following code that I think closely follows the intent of the Elixir code.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">scratch.core</span>
<span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.async</span> <span class="ss">:as</span> <span class="nv">async</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">go</span> <span class="nv">&lt;!</span> <span class="nv">chan</span> <span class="nv">&gt;!!</span> <span class="nv">&lt;!!</span> <span class="nv">&gt;!</span><span class="p">]])</span>
<span class="p">(</span><span class="ss">:gen-class</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">inc-and-pass-on</span> <span class="p">[</span><span class="nv">in</span> <span class="nv">out</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">go</span> <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">n</span> <span class="p">(</span><span class="nf">&lt;!</span> <span class="nv">in</span><span class="p">)]</span>
      <span class="p">(</span><span class="nf">&gt;!</span> <span class="nv">out</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">n</span><span class="p">)))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">run-it</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">chans</span> <span class="p">(</span><span class="nf">partition</span> <span class="mi">2</span> <span class="mi">1</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">n</span> <span class="nv">chan</span><span class="p">))</span>
        <span class="nv">start</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">first </span><span class="nv">chans</span><span class="p">))</span>
        <span class="nv">end</span> <span class="p">(</span><span class="nb">last </span><span class="p">(</span><span class="nb">last </span><span class="nv">chans</span><span class="p">))]</span>
    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">c</span> <span class="nv">chans</span><span class="p">]</span>
      <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">in</span> <span class="nv">out</span><span class="p">]</span> <span class="nv">c</span><span class="p">]</span>
        <span class="p">(</span><span class="nf">inc-and-pass-on</span> <span class="nv">in</span> <span class="nv">out</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">&gt;!!</span> <span class="nv">start</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;result is &quot;</span> <span class="p">(</span><span class="nf">&lt;!!</span> <span class="nv">end</span><span class="p">))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">run</span> <span class="p">[]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">start</span> <span class="p">(</span><span class="k">. </span><span class="nv">System</span> <span class="nv">currentTimeMillis</span><span class="p">)</span>
          <span class="nv">_</span>     <span class="p">(</span><span class="nf">run-it</span> <span class="mi">1000000</span><span class="p">)</span>
          <span class="nv">end</span>   <span class="p">(</span><span class="k">. </span><span class="nv">System</span> <span class="nv">currentTimeMillis</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Ran in&quot;</span> <span class="p">(</span><span class="nb">- </span><span class="nv">end</span> <span class="nv">start</span><span class="p">)</span> <span class="s">&quot;ms&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">run</span><span class="p">))</span>
</pre></div>
</td></tr></table>

<p>I was very impressed that this took about the same time as the Elixir code, after a few runs to allow the Hotspot optimisations to kick in. The non-blocking nature of Clojure's core.async go blocks are impressive. This also seemed to take about the same amount of memory as the Elixir version.</p>
<p>Lastly I thought I would have a try at doing this in Go, as core.async follows a similar CSP model as Go. I'm not very familar with Go, but quickly came up with the following:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kn">import</span> <span class="s">&quot;time&quot;</span>

<span class="kd">func</span> <span class="nx">inc</span><span class="p">(</span><span class="nx">in</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">out</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="kt">int</span>
  <span class="nx">i</span> <span class="p">=</span> <span class="o">&lt;-</span> <span class="nx">in</span>
  <span class="nx">out</span> <span class="o">&lt;-</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">1000000</span>
  <span class="kd">var</span> <span class="nx">chans</span> <span class="p">[</span><span class="nx">n</span><span class="p">]</span><span class="kd">chan</span> <span class="kt">int</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">chans</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="k">go</span> <span class="nx">inc</span><span class="p">(</span><span class="nx">chans</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">chans</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="nx">chans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="mi">1</span>
  <span class="nx">result</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="nx">chans</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">end</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Result is &quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="s">&quot; and it took &quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Using Go 1.4 the compiled binary executes this in about 2.3sec. I am very surprised with this, how fast Go is compared with the others. It seems to use about the same memory too as the Elixir version. About 2 Gig. If only I prefer the more functional style of Elixir/Clojure. Go still allows shared mutable state issues without care, though worth investigating a bit more given these results.</p>
<p>Disclaimer: Take micro benchmarks with a grain of salt.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://twitter.com/eldritchideen"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://github.com/eldritchideen"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://au.linkedin.com/in/stevejcook1"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Steven Cook
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


</body>
</html>